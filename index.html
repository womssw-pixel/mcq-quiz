<!--Developed by S3n;t-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCQ Quiz with Leaderboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.correct-answer { background-color: #d1fae5; border-color: #10b981; }
.correct-answer-text { color: #10b981; }
.wrong-answer { background-color: #fee2e2; border-color: #ef4444; }
.wrong-answer-text { color: #ef4444; }
#quiz-header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 1rem 2rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.main-quiz-container { padding-top: 120px; transform: translateY(100px);}
.fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.5s ease-out forwards; margin-left:auto;margin-right:auto; max-width:700px;}
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
.option-btn { transition: all 0.25s ease; cursor: pointer; }
.option-btn:hover { transform: scale(1.02); background-color: #e0f2fe; box-shadow: 0 6px 15px rgba(0,0,0,0.18); }
.option-btn:active { transform: scale(0.97); box-shadow: none; }
.slide-in { transform: translateY(-20px); opacity: 0; animation: slideIn 0.6s cubic-bezier(0.25,1.25,0.5,1) forwards; }
@keyframes slideIn { to { transform: translateY(0); opacity: 1; } }
.blinking { animation: blink 1s infinite; }
@keyframes blink { 0%,100%{border-color:#fa4545;color:white;} 50%{border-color:#1a1a1a;color:black;} }
.modal { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 2000; background-color: rgba(0,0,0,0.6); }
#leaderboard-modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 4000; animation: fadeInModal 0.3s ease-out forwards; }
#leaderboard-content { background:white; padding:2rem; border-radius:1rem; max-width:600px; width:90%; text-align:center; position: relative; z-index: 10; }
@keyframes fadeInModal { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
#day-selection { display:none; text-align:center; margin-top:150px; }
.day-btn { margin:0.5rem 1rem; padding:0.5rem 1.5rem; background:#3b82f6; color:white; border-radius:0.5rem; cursor:pointer; }
.day-btn:hover { background:#2563eb; }
.leaderboard-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; text-align: center; border-radius: 10px; border: 1px solid #d8d6d6; overflow: hidden; }
.leaderboard-table th, .leaderboard-table td { border: 1px solid #ddd; padding: 8px; }
.leaderboard-table th { background-color: #ffffff; color: rgb(0, 0, 0); }
.leaderboard-student { background-color: #78f56d;}
.leaderboard-table tr:hover { background-color: #d3d3d3; }
#nameBox{ animation: popup 0.5s ease-in forwards;}
@keyframes popup { 0%{scale: 90%; opacity: 0; transform: scaleX(75%) scaleY(90%);} 50%{scale: 105%; transform: scaleX(100%); opacity: 1;} 70%{transform: scaleY(100%);} 100%{scale: 100%; }}
.leaderboard-row { opacity: 0; transform: translateX(-50px); animation: fadeInRow 0.5s forwards; }
@keyframes fadeInRow { to { opacity: 1; transform: translateX(0); } }
.leaderboard-table td:nth-child(1){ border-right: none; }
.leaderboard-table td:nth-child(2) { border-left: none; border-right: none; }
.leaderboard-table td:nth-child(3) { border-left: none; }
#confetti-canvas { position:absolute; inset:0; pointer-events:none; z-index:4000; width: 100%; height: 100%; }
.alert-modal-content { animation: popup 0.5s ease-in forwards; }
</style>
</head>
<body class="flex flex-col items-center min-h-screen">

<div id="name-modal" class="modal">
  <div id="nameBox" class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to the ESAG Quiz Center!</h2>
    <p class="text-gray-600 mb-6">Please enter your name to begin.</p>
    <input type="text" id="student-name-input" placeholder="Your Name"
           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 mb-4">
    <button id="start-quiz-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition">
      Continue
    </button>
  </div>
</div>

<div id="alert-modal" class="modal hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center alert-modal-content">
        <div class="p-4 bg-red-100 rounded-lg text-red-700 mb-4">
            <h3 class="font-bold">Name Taken!</h3>
            <p class="text-sm mt-1">This name is already in use. Please try a different name.</p>
        </div>
        <button id="close-alert-btn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-700 transition">
            Close
        </button>
    </div>
</div>

<div id="day-selection" class="hidden">
  <h2 class="text-2xl font-bold mb-4">Physics MCQ Day 1</h2>
  <p class="text-2xl">This quiz is timed ⏳<br>Good luck :)</p>
  <button class="day-btn">Start Quiz</button>
</div>

<header id="quiz-header" class="hidden">
  <h1 class="text-2xl font-bold text-gray-800">Physics MCQ Quiz</h1>
  <div id="timer-box" class="flex items-center bg-gray-100 px-3 py-2 rounded-full border border-gray-300 shadow-sm transition">
    <img src="https://www.svgrepo.com/show/155032/sand-clock.svg" alt="Hourglass" class="h-6 w-6">
    <div id="timer" class="ml-2 text-lg font-semibold text-gray-800 w-16 text-center tabular-nums">25:00</div>
  </div>
</header>

<div id="quiz-wrapper" class="hidden bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-2xl w-full main-quiz-container">
  <div id="quiz-container"></div>
  <button id="submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition mt-6">
    Submit Quiz
  </button>

  <div id="results-container" class="hidden mt-6">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Quiz Results</h2>
    <div id="score-display" class="text-center text-2xl font-semibold mb-6"></div>
    <div id="answers-review"></div>
    <button id="show-leaderboard-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-700 transition mt-3 hidden">
      Show Leaderboard
    </button>
  </div>
</div>

<div id="leaderboard-modal" class="modal">
  <canvas id="confetti-canvas"></canvas>
  <div id="leaderboard-content">
    <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
    <div id="leaderboard-entries" class="mb-4"></div>
    <button id="close-leaderboard-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA9cJ_wC_6h5PWRMw96rUDrMBE_uCIClF8",
  authDomain: "esag-mcq-project.firebaseapp.com",
  projectId: "esag-mcq-project",
  storageBucket: "esag-mcq-project.appspot.com",
  messagingSenderId: "53701860084",
  appId: "1:53701860084:web:eca61389e9860ccbed1ca1",
  measurementId: "G-PNFL3KQ68K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const quizzes = {
  "Day 1": [
    { questionImage:"https://placehold.co/600x400/007bff/ffffff?text=Day+1+Q1", options:["1","2","3","4","5"], correctAnswer:"2" },
    { questionImage:"https://placehold.co/600x400/28a745/ffffff?text=Day+1+Q2", options:["1","2","3","4","5"], correctAnswer:"1" }
  ]
};
const setTime = 2;
const collectionName = 'students';
const timerDisplay = document.getElementById('timer');
const timerBox = document.getElementById('timer-box');
const quizContainer = document.getElementById('quiz-container');
const resultsContainer = document.getElementById('results-container');
const submitBtn = document.getElementById('submit-btn');
const scoreDisplay = document.getElementById('score-display');
const answersReview = document.getElementById('answers-review');
const nameModal = document.getElementById('name-modal');
const startQuizBtn = document.getElementById('start-quiz-btn');
const studentNameInput = document.getElementById('student-name-input');
const quizWrapper = document.getElementById('quiz-wrapper');
const daySelection = document.getElementById('day-selection');
const showLeaderboardBtn = document.getElementById('show-leaderboard-btn');
const leaderboardModal = document.getElementById('leaderboard-modal');
const leaderboardEntries = document.getElementById('leaderboard-entries');
const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
const quizHeader = document.getElementById('quiz-header');
const confettiCanvas = document.getElementById('confetti-canvas');
const alertModal = document.getElementById('alert-modal');
const closeAlertBtn = document.getElementById('close-alert-btn');

let studentName='', studentID='', userAnswers={}, timeLeft=setTime*60, timerInterval, currentDay='Day 1';

// Prefill saved name and ID
const savedName = localStorage.getItem("studentName");
if (savedName) studentNameInput.value = savedName;
const savedID = localStorage.getItem("studentID");
if (savedID) studentID = savedID;

// Leaderboard function
async function showLeaderboard(currentStudent){
  leaderboardEntries.innerHTML='Loading...';
  leaderboardModal.style.display='flex';
  const confettiInstance = confetti.create(confettiCanvas, { resize:true, useWorker:true });
  try {
    const q = query(
      collection(db, collectionName),
      where("day", "==", currentDay),
      orderBy("score","desc"),
      orderBy("timeSpent","asc"),
      limit(10)
    );
    const snapshot = await getDocs(q);
    if(snapshot.empty){ leaderboardEntries.innerHTML='No entries yet'; return; }

    let table = `<table class="leaderboard-table"><thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead><tbody>`;
    let rank = 1;
    snapshot.forEach((doc) => {
      const d = doc.data();
      const isCurrent = d.name === currentStudent;
      table += `<tr class="leaderboard-row ${isCurrent ? 'leaderboard-student' : ''}" style="animation-delay:${(rank-1)*0.1}s"><td>${rank}</td><td>${d.name}</td><td>${d.score}</td></tr>`;
      if(isCurrent) confettiInstance({ particleCount: 80, spread: 70, origin: { y: 0.3 } });
      rank++;
    });
    table += `</tbody></table>`;
    leaderboardEntries.innerHTML = table;
  } catch(err) {
    console.error(err);
    leaderboardEntries.innerHTML='Error loading leaderboard.';
  }
}

// Name modal logic
startQuizBtn.addEventListener('click', async () => {
  studentName = studentNameInput.value.trim();
  if(!studentName) {
    // Re-using the same modal for "Please enter your name"
    alertModal.querySelector('h3').textContent = 'Name Required!';
    alertModal.querySelector('p').textContent = 'Please enter your name to continue.';
    alertModal.style.display = 'flex';
    return;
  }

  const nameQuery = query(collection(db, collectionName), where("name","==",studentName));
  const snapshot = await getDocs(nameQuery);

  if(!studentID) {
    studentID = crypto.randomUUID();
    localStorage.setItem("studentID", studentID);
  }

  if(!snapshot.empty){
    const data = snapshot.docs[0].data();
    if(data.id !== studentID){
      // Show custom name taken modal instead of alert()
      alertModal.querySelector('h3').textContent = 'Name Taken!';
      alertModal.querySelector('p').textContent = 'This name is already in use. Please try a different name.';
      alertModal.style.display = 'flex';
      return;
    }
    // Student exists → show result sheet
    const savedAnswers = data.answers || {};
    const savedScore = data.score || 0;
    nameModal.style.display = 'none';
    quizWrapper.style.display = 'block';
    quizHeader.classList.remove('hidden');
    resultsContainer.classList.remove('hidden');
    submitBtn.style.display = 'none';
    scoreDisplay.textContent = `Your Score: ${savedScore} / ${quizzes[currentDay].length}`;
    answersReview.innerHTML='';
    quizzes[currentDay].forEach((q,i)=>{
      const ans = savedAnswers[i] || '';
      const div = document.createElement('div');
      div.className='mb-6 p-4 rounded-lg border';
      div.innerHTML=`<div class="mb-3 rounded overflow-hidden border-2 border-gray-200 shadow-sm">
        <img class="w-full h-auto object-cover" src="${q.questionImage}" alt="Question ${i+1}">
      </div>
      <p class="${ans==q.correctAnswer?'correct-answer-text':'wrong-answer-text'}">
        Q${i+1} - Your Answer: ${ans || "No Answer"} | Correct: ${q.correctAnswer}
      </p>`;
      if(ans==q.correctAnswer) div.classList.add('correct-answer');
      else div.classList.add('wrong-answer');
      answersReview.appendChild(div);
    });
    showLeaderboardBtn.classList.remove('hidden');
    localStorage.setItem("studentName", studentName);
    return;
  }

  // Name not taken → proceed
  nameModal.style.display = 'none';
  daySelection.style.display = 'block';
  localStorage.setItem("studentName", studentName);
});

// Close alert modal logic
closeAlertBtn.addEventListener('click', () => {
    alertModal.style.display = 'none';
});

studentNameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') startQuizBtn.click(); });

// Middle page
document.querySelector('.day-btn').addEventListener('click', () => {
  daySelection.style.display = 'none';
  quizWrapper.style.display = 'block';
  quizHeader.classList.remove('hidden');
  renderAllQuestions(quizzes[currentDay]);
  startTimer();
});

// Render questions
function renderAllQuestions(quiz){
  quizContainer.innerHTML='';
  quiz.forEach((q,i)=>{
    const card = document.createElement('div');
    card.className="mb-8 p-6 bg-gray-50 rounded-lg border-2 border-gray-100 shadow-md fade-in";
    let optionsHtml='';
    q.options.forEach((opt,oi)=>{
      optionsHtml+=`<button class="w-full text-left bg-gray-100 text-gray-800 font-medium py-3 px-4 rounded-lg border-2 border-gray-300 option-btn" data-question-index="${i}" data-option="${oi+1}">${opt}</button>`;
    });
    card.innerHTML=`<h2 class="text-xl font-semibold text-gray-700 mb-4">Question ${i+1}</h2>
      <div class="rounded-lg overflow-hidden border-2 border-gray-200 shadow-sm mb-4">
        <img class="w-full h-auto object-cover" src="${q.questionImage}" alt="Question ${i+1}">
      </div>
      <div class="options-container grid gap-3">${optionsHtml}</div>`;
    quizContainer.appendChild(card);
  });
  quizContainer.addEventListener('click', e=>{
    const target=e.target;
    if(target.matches('[data-option]')){
      const qIndex=target.dataset.questionIndex;
      const opt=target.dataset.option;
      handleAnswer(qIndex,opt);
    }
  });
}

// Handle answer
function handleAnswer(qIndex,opt){
  userAnswers[qIndex]=opt;
  const opts=quizContainer.querySelectorAll(`[data-question-index="${qIndex}"]`);
  opts.forEach(b=>b.classList.remove('bg-blue-200','border-blue-500'));
  const selBtn=quizContainer.querySelector(`[data-question-index="${qIndex}"][data-option="${opt}"]`);
  if(selBtn) selBtn.classList.add('bg-blue-200','border-blue-500');
}

// Timer
function startTimer(){
  timerInterval=setInterval(()=>{
    timeLeft--;
    const m=Math.floor(timeLeft/60).toString().padStart(2,'0');
    const s=(timeLeft%60).toString().padStart(2,'0');
    timerDisplay.textContent=`${m}:${s}`;
    
    // Add or remove blinking class based on time left
    if(timeLeft < 60 && timeLeft > 0) {
      timerBox.classList.add('blinking');
    } else {
      timerBox.classList.remove('blinking');
    }

    if(timeLeft <= 0){
      clearInterval(timerInterval);
      submitQuiz();
    }
  },1000);
}

// Submit
submitBtn.addEventListener('click', submitQuiz);
function submitQuiz(){
  clearInterval(timerInterval);
  const quizData = quizzes[currentDay];
  let score=0;
  quizData.forEach((q,i)=>{
    if(userAnswers[i]==q.correctAnswer) score++;
  });
  scoreDisplay.textContent=`Your Score: ${score} / ${quizData.length}`;
  
  // Hide quiz questions
  quizContainer.style.display = 'none';
  submitBtn.style.display='none';
  resultsContainer.classList.remove('hidden');
  showLeaderboardBtn.classList.remove('hidden');

  // Save to Firestore
  const docRef = doc(db, collectionName, studentID);
  setDoc(docRef, { name: studentName, id: studentID, day: currentDay, answers: userAnswers, score:score, timeSpent:setTime*60-timeLeft });

  // Show answers
  answersReview.innerHTML='';
  quizData.forEach((q,i)=>{
    const ans=userAnswers[i]||'';
    const div=document.createElement('div');
    div.className='mb-6 p-4 rounded-lg border';
    div.innerHTML=`<div class="mb-3 rounded overflow-hidden border-2 border-gray-200 shadow-sm">
      <img class="w-full h-auto object-cover" src="${q.questionImage}" alt="Question ${i+1}">
    </div>
    <p class="${ans==q.correctAnswer?'correct-answer-text':'wrong-answer-text'}">
      Q${i+1} - Your Answer: ${ans||"No Answer"} | Correct: ${q.correctAnswer}
    </p>`;
    if(ans==q.correctAnswer) div.classList.add('correct-answer');
    else div.classList.add('wrong-answer');
    answersReview.appendChild(div);
  });
}

// Leaderboard
showLeaderboardBtn.addEventListener('click',()=>showLeaderboard(studentName));
closeLeaderboardBtn.addEventListener('click',()=>leaderboardModal.style.display='none');
</script>
</body>
</html>
