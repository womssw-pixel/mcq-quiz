<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESAG Quiz Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.container { max-width: 900px; margin-left: auto; margin-right: auto; padding: 2rem; }
.input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; }
.btn-primary { background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s; }
.btn-primary:hover { background-color: #2563eb; }
.btn-danger { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
.btn-danger:hover { background-color: #dc2626; }
.btn-warning { background-color: #f59e0b; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
.btn-warning:hover { background-color: #d97706; }
.fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.5s ease-out forwards; }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mt-10 fade-in">
    <h1 class="text-3xl font-bold text-center mb-8">ESAG Quiz Admin Panel üõ†Ô∏è</h1>

    <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
        <h2 id="form-title" class="text-2xl font-bold mb-4">Add New Question</h2>
        <form id="question-form">
            <input type="hidden" id="question-id">
            <input type="hidden" id="question-day" value="Day 1">
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Question Image URL</label>
                <input type="text" id="question-image" class="input-field" placeholder="e.g., https://example.com/image.png" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Correct Answer (1-5)</label>
                <input type="number" id="correct-answer" class="input-field" min="1" max="5" placeholder="e.g., 2" required>
            </div>
            <button type="submit" id="submit-btn" class="btn-primary w-full">Add Question</button>
            <button type="button" id="cancel-edit-btn" class="btn-warning w-full mt-2 hidden">Cancel Edit</button>
        </form>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Existing Questions</h2>
        <div id="questions-list" class="space-y-6">
            <p class="text-center text-gray-500">Loading questions...</p>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA9cJ_wC_6h5PWRMw96rUDrMBE_uCIClF8",
    authDomain: "esag-mcq-project.firebaseapp.com",
    projectId: "esag-mcq-project",
    storageBucket: "esag-mcq-project.appspot.com",
    messagingSenderId: "53701860084",
    appId: "1:53701860084:web:eca61389e9860ccbed1ca1",
    measurementId: "G-PNFL3KQ68K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const questionsCollection = collection(db, "questions");

const form = document.getElementById('question-form');
const questionImageInput = document.getElementById('question-image');
const correctAnswerInput = document.getElementById('correct-answer');
const questionsList = document.getElementById('questions-list');
const submitBtn = document.getElementById('submit-btn');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const formTitle = document.getElementById('form-title');
const questionIdInput = document.getElementById('question-id');

let currentDay = 'Day 1';
let nextQuestionNumber = 1;

async function fetchQuestions() {
    questionsList.innerHTML = '<p class="text-center text-gray-500">Loading questions...</p>';
    try {
        // Query without orderBy to avoid composite index error
        const q = query(questionsCollection, where("day", "==", currentDay));
        const snapshot = await getDocs(q);
        let questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Sort on the client-side
        questions.sort((a, b) => {
            const numA = parseInt(a.id.replace('Q', '')) || 0;
            const numB = parseInt(b.id.replace('Q', '')) || 0;
            return numA - numB;
        });

        if (questions.length > 0) {
            const lastQuestionId = questions[questions.length - 1].id;
            const lastNumber = parseInt(lastQuestionId.replace('Q', '')) || 0;
            nextQuestionNumber = lastNumber + 1;
        } else {
            nextQuestionNumber = 1;
        }

        renderQuestions(questions);
    } catch (error) {
        console.error("Error fetching questions:", error);
        questionsList.innerHTML = '<p class="text-center text-red-500">Error loading questions.</p>';
    }
}

function renderQuestions(questions) {
    questionsList.innerHTML = '';
    if (questions.length === 0) {
        questionsList.innerHTML = '<p class="text-center text-gray-500">No questions found for this day. Add a new one!</p>';
        return;
    }
    questions.forEach(q => {
        const questionCard = document.createElement('div');
        questionCard.className = "bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm fade-in";
        questionCard.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Question ${q.id}</h3>
                <div>
                    <button class="btn-warning edit-btn" data-id="${q.id}">Edit</button>
                    <button class="btn-danger delete-btn" data-id="${q.id}">Delete</button>
                </div>
            </div>
            <div class="mb-4">
                <img src="${q.questionImage}" alt="Question Image" class="w-full h-auto object-contain max-h-60 rounded-md">
            </div>
            <p class="font-bold mt-2">Correct Answer: Option ${q.correctAnswer}</p>
        `;
        questionsList.appendChild(questionCard);
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const docRef = doc(db, 'questions', id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                questionIdInput.value = id;
                questionImageInput.value = data.questionImage;
                correctAnswerInput.value = data.correctAnswer;
                formTitle.textContent = `Edit Question ${id}`;
                submitBtn.textContent = 'Save Changes';
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            if (confirm("Are you sure you want to delete this question?")) {
                const id = e.target.dataset.id;
                await deleteDoc(doc(db, 'questions', id));
                fetchQuestions();
            }
        });
    });
}

function clearForm() {
    questionIdInput.value = '';
    questionImageInput.value = '';
    correctAnswerInput.value = '';
    formTitle.textContent = 'Add New Question';
    submitBtn.textContent = 'Add Question';
    cancelEditBtn.classList.add('hidden');
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = questionIdInput.value;
    const questionData = {
        questionImage: questionImageInput.value,
        options: ["Option 1", "Option 2", "Option 3", "Option 4", "Option 5"],
        correctAnswer: parseInt(correctAnswerInput.value),
        day: currentDay
    };

    if (!questionData.questionImage || !questionData.correctAnswer) {
        alert("Please fill in all fields.");
        return;
    }

    if (id) {
        await setDoc(doc(db, 'questions', id), questionData);
    } else {
        const newId = `Q${nextQuestionNumber}`;
        await setDoc(doc(questionsCollection, newId), questionData);
    }
    clearForm();
    fetchQuestions();
});

cancelEditBtn.addEventListener('click', () => {
    clearForm();
});

fetchQuestions();
</script>

</body>
</html>
